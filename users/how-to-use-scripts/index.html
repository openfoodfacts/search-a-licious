
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://openfoodfacts.github.io/search-a-licious/users/how-to-use-scripts/">
      
      
        <link rel="prev" href="../how-to-update-index/">
      
      
        <link rel="next" href="../explain-configuration/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.1">
    
    
      
        <title>How to use scripts - Search-a-licious documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a40c8224.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-use-scripts" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Search-a-licious documentation" class="md-header__button md-logo" aria-label="Search-a-licious documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Search-a-licious documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to use scripts
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/openfoodfacts/search-a-licious" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Search-a-licious documentation" class="md-nav__button md-logo" aria-label="Search-a-licious documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Search-a-licious documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/openfoodfacts/search-a-licious" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Search-a-licious
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Users
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Users
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorial - Using search-a-licious in your project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install search-a-licious
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-update-index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to update the index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    How to use scripts
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    How to use scripts
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declare-the-script-in-the-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Declare the script in the configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-the-scripts-in-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      Import the scripts in Elasticsearch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-web-components" class="md-nav__link">
    <span class="md-ellipsis">
      Using web components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-script-in-the-api" class="md-nav__link">
    <span class="md-ellipsis">
      Using the script in the API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privacy-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Privacy considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance considerations
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../explain-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explain configuration file
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../explain-query-language/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explain Query Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../explain-taxonomies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explain taxonomies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ref-config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference for Configuration file
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ref-openapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference for Search-a-licious API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ref-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference for Settings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ref-web-components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference for Search-a-licious Web Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Devs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Devs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/how-to-debug-backend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Debug the backend app
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/how-to-install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to install for local development
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/explain-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explain Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/explain-web-frontend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explain web frontend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devs/ref-python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ref: Python Code documentation 🡕
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#declare-the-script-in-the-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Declare the script in the configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-the-scripts-in-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      Import the scripts in Elasticsearch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-web-components" class="md-nav__link">
    <span class="md-ellipsis">
      Using web components
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-the-script-in-the-api" class="md-nav__link">
    <span class="md-ellipsis">
      Using the script in the API
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#privacy-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Privacy considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance considerations
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="how-to-use-scripts">How to use scripts<a class="headerlink" href="#how-to-use-scripts" title="Permanent link">#</a></h1>
<p>You can use scripts to sort results in your search requests.</p>
<p>It enables to provides results that depends upon users defined preferences.</p>
<p>This leverage a possibility of Elasticsearch of <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sort-search-results.html#script-based-sorting">script based sorting</a>.</p>
<p>Using scripts needs the following steps:</p>
<ol>
<li><a href="#declare-the-script-in-the-configuration">declare the scripts than can be used in the configuration</a></li>
<li><a href="#import-the-script-in-elasticsearch">import the scripts in Elasticsearch</a></li>
<li>either use web-components to sort using scripts or call the search API using the script name, and providing parameters</li>
</ol>
<h2 id="declare-the-script-in-the-configuration">Declare the script in the configuration<a class="headerlink" href="#declare-the-script-in-the-configuration" title="Permanent link">#</a></h2>
<p>You have to declare the scripts that can be used for sorting in your configuration.</p>
<p>This has two advantages:</p>
<ul>
<li>this keeps the API call simple, by just refering to the script by name</li>
<li>this is more secure as you are in full control of scripts that are allowed to be used.</li>
</ul>
<p>The scripts section can look something like this:
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nt">scripts</span><span class="p">:</span>
<span class="w">      </span><span class="nt">personal_score</span><span class="p">:</span><span class="w"> </span><span class="c1"># see 1</span>
<span class="w">        </span><span class="c1"># see https://www.elastic.co/guide/en/elasticsearch/painless/8.14/index.html</span>
<span class="w">        </span><span class="nt">lang</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">painless</span><span class="w">  </span><span class="c1"># see 2</span>
<span class="w">        </span><span class="c1"># the script source, here a trivial example</span>
<span class="w">        </span><span class="c1"># see 3</span>
<span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">          </span><span class="no">doc[params[&quot;preferred_field&quot;]].size &gt; 0 ? doc[params[&quot;preferred_field&quot;]].value : (doc[params[&quot;secondary_field&quot;]].size &gt; 0 ? doc[params[&quot;secondary_field&quot;]].value : 0)</span>
<span class="w">        </span><span class="c1"># gives an example of parameters</span>
<span class="w">        </span><span class="c1"># see 4</span>
<span class="w">        </span><span class="nt">params</span><span class="p">:</span>
<span class="w">          </span><span class="nt">preferred_field</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;field1&quot;</span>
<span class="w">          </span><span class="nt">secondary_field</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;field2&quot;</span>
<span class="w">        </span><span class="c1"># more non editable parameters, can be easier than to declare constants in the script</span>
<span class="w">        </span><span class="c1"># see 5</span>
<span class="w">        </span><span class="nt">static_params</span><span class="p">:</span>
<span class="w">          </span><span class="nt">param1 </span><span class="p">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span>
</code></pre></div></p>
<p>Here:</p>
<ol>
<li>
<p>we declare a script named <code>personal_score</code>, this is the name you will use in your API requests and/or web-components attributes</p>
</li>
<li>
<p>we declare the language of the script, in this case <code>painless</code>, search-a-licious supports <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-painless.html">painless</a> and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-expression.html">Lucene expressions</a></p>
</li>
<li>
<p>this is the source of the script. It can be a bit tedious to write those scripts. You can use the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-painless.html">Elasticsearch documentation</a> to get a better understanding of the language.</p>
<p>In this example we are using a one liner, but your scripts can be far more complex.</p>
</li>
<li>
<p>Parameters are a way to add inputs to the script.
   You can declare them using an example. You can provide more complex structures, as allowed by JSON.
   Those parameters will be given through the API requests</p>
</li>
<li>
<p>static_params are parameters that are not allowed to change through the API.
   It's mostly a way to declare constants in the script.
   (hopefully more convenient than declaring them in the script)</p>
</li>
</ol>
<p>For more information on configuration for scripts see <a href="../ref-config/searchalicious-config-schema.html#indices_additionalProperties_scripts">configuration reference</a></p>
<p>For informations on how to write scripts,
see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting-using.html">introduction to script in Elasticsearch documentation</a></p>
<h2 id="import-the-scripts-in-elasticsearch">Import the scripts in Elasticsearch<a class="headerlink" href="#import-the-scripts-in-elasticsearch" title="Permanent link">#</a></h2>
<p>Each time you change the configuration, you have to import the scripts in Elasticsearch.</p>
<p>For this you only need to run the sync-scripts command.</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>compose<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>api<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>app<span class="w"> </span>sync-scripts
</code></pre></div>
<h2 id="using-web-components">Using web components<a class="headerlink" href="#using-web-components" title="Permanent link">#</a></h2>
<p>After you have registered a script, it can be used for sorting using Search-a-licious provided web components.</p>
<p>We imagine that you already have setup a search page, with, at least a <code>searchalicious-bar</code> (eventually refer to <a href="../tutorial/#building-a-search-interface">tutorial on building a search interface</a>).</p>
<p>In your <a href="./ref-web-components/#searchalicious-sort"><code>searchalicious-sort</code></a> component, you can add multiple sort options.
While <a href="./ref-web-components/#searchalicious-sort-field"><code>searchalicious-sort-field</code></a> component add sorting on a field,
you can use <a href="./ref-web-components/#searchalicious-sort-script"><code>searchalicious-sort-script</code></a> to add sorting on a script.</p>
<p>This component has:</p>
<ul>
<li>an attribute to set the script name, corresponding to the name you have declared in the configuration.</li>
<li>an attribute to set the parameters for this sort option.
  This in turn can:<ul>
<li>either be a string encoding a JSON Object (if your parameters are in some way static, or you set them through javascript)</li>
<li>either be a key corresponding to a value in the local storage.
  In this case it must be prefixed with <code>storage:</code>, and the value must be the key in the local storage.</li>
</ul>
</li>
</ul>
<p>Using static parameters can be an option if you are reusing the same script but for different scenarios.
Imagine you have a script like the one given in example above,
you could reuse the script to sort either on portion size or quantity (if no portion size),
or to sort on nutriscore or sugar per 100g (if no nutriscore).</p>
<p>Note that in this case you must provide an <code>id</code> to at least one of the sort option
(because default id is based on script name).</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">searchalicious-sort</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">searchalicious-sort-script</span>
    <span class="na">script</span><span class="o">=</span><span class="s">&quot;personal_score&quot;</span>
    <span class="na">id</span><span class="o">=</span><span class="s">&quot;sort-by-quantity&quot;</span>
    <span class="na">parameters</span><span class="o">=</span><span class="s">&#39;{&quot;preferred_field&quot;: &quot;portion_size&quot;, &quot;secondary_field&quot;: &quot;quantity&quot;}&#39;</span>
  <span class="p">&gt;</span>
    Sort by portion size (fallback on quantity)
  <span class="p">&lt;/</span><span class="nt">searchalicious-sort-script</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">searchalicious-sort-script</span>
    <span class="na">script</span><span class="o">=</span><span class="s">&quot;personal_score&quot;</span>
    <span class="na">id</span><span class="o">=</span><span class="s">&quot;sort-by-nutrition&quot;</span>
    <span class="na">parameters</span><span class="o">=</span><span class="s">&#39;{&quot;preferred_field&quot;: &quot;nutriscore&quot;, &quot;secondary_field&quot;: &quot;sugar_per_100g&quot;}&#39;</span>
  <span class="p">&gt;</span>
    Sort by Nutri-Score (fallback on sugar per 100g)
  <span class="p">&lt;/</span><span class="nt">searchalicious-sort-script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">searchalicious-sort</span><span class="p">&gt;</span>
</code></pre></div>
<p>On the other side, using dynamic parameters can be an option if you want to let the user choose the field to sort on.
For this you will need an independant way to set the values to sort on (your own UI) that either:</p>
<ul>
<li>dynamically modifies your searchalicious-sort-script element to change parameters property</li>
<li>either stores it in local storage</li>
</ul>
<p>The later option as the advantage that it will survive a reload of the page or be still present on another visit.
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">searchalicious-sort</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">searchalicious-sort-script</span>
    <span class="na">script</span><span class="o">=</span><span class="s">&quot;personal_score&quot;</span>
    <span class="na">parameters</span><span class="o">=</span><span class="s">&#39;local:personal-score-params&#39;</span>
  <span class="p">&gt;</span>
    Sort according to my preferences
  <span class="p">&lt;/</span><span class="nt">searchalicious-sort-script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">searchalicious-sort</span><span class="p">&gt;</span>
</code></pre></div></p>
<h2 id="using-the-script-in-the-api">Using the script in the API<a class="headerlink" href="#using-the-script-in-the-api" title="Permanent link">#</a></h2>
<p>You might also want to use the sort by script option in the API.</p>
<p>For this:</p>
<ul>
<li>you must issue a POST request to the <code>/api/search</code> endpoint</li>
<li>you must pass a JSON payload with:<ul>
<li>the script name in the <code>sort_by</code> property</li>
<li>you must provide the <code>sort_params</code>  property with a valid JSON object, corresponding to your parameters.</li>
</ul>
</li>
</ul>
<p>Let's use the same example as above, we could launch a search on whole database using our <code>personal_script</code> script, using curl
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;sort_by&quot;: &quot;personal_score&quot;,</span>
<span class="s1">    &quot;sort_params&quot;: {&quot;preferred_field&quot;: &quot;nutriscore&quot;, &quot;secondary_field&quot;: &quot;sugar_per_100g&quot;}</span>
<span class="s1">  }&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>http://localhost:8000/api/search
</code></pre></div></p>
<h2 id="privacy-considerations">Privacy considerations<a class="headerlink" href="#privacy-considerations" title="Permanent link">#</a></h2>
<p>The sort by script option was designed to allow users to sort their results according to their preferences.</p>
<p>In the context of Open Food Facts, those preferences can reveal data which should remain privates.</p>
<p>That's why we enforce using a <code>POST</code> request in the API (to avoid accidental logging),
and we try hard not to log this data inside search-a-licious.</p>
<h2 id="performance-considerations">Performance considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">#</a></h2>
<p>When you use scripts for sorting, bare in mind that they needs to be executed on each document.</p>
<p>Tests your results on your full dataset to make sure performances are not an issue.</p>
<p>An heavy load on scripts sorting might affect other requests as well under an heavy load.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5090c770.min.js"></script>
      
    
  </body>
</html>