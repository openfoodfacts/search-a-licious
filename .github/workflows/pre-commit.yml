name: Run checks

on:
  pull_request:
    branches: [ main ]

jobs:
  checks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: install python
      uses: actions/setup-python@v5
      with:
        # FIXME: currently a bug prevent from using 3.11
        # /home/runner/.cache/pre-commit/repokffp0m9p/py_env-python3.11/lib/python3.11/site-packages/redis-stubs/cluster.pyi:253: error: Positional-only parameters are only supported in Python 3.8 and greater
        # see https://github.com/python/mypy/issues/13635#issuecomment-1241328210
        python-version: 3.10.6
    - name: build docker containers
      run: |
        echo "" > .envrc
        echo CONFIG_PATH=data/config/openfoodfacts.yml >> .envrc
        echo OFF_API_URL=https://world.openfoodfacts.org >> .envrc
        echo USER_IID=$(id -u) >>.envrc
        echo USER_GID=$(id -g) >>.envrc
        make build
    - name: Enforce pre-commit hook server side
      uses: pre-commit/action@v3.0.1
    - name: run tests
      run: make test
